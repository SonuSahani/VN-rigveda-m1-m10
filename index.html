<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>·πöta's Whisper ‚Äî Mandala I Full Enhanced</title>
<style>
  :root{
    --primary:#4a90e2;
    --accent:#ffd700;
    --bg-dark:#0f0c29;
    --bg-mid:#302b63;
    --bg-light:#24243e;
    --text:#ffffff;
    --panel: rgba(2,2,6,0.7);
    --glass: rgba(255,255,255,0.03);
    /* Sprite layout targets: 70% visible, 20% behind dialogue, 10% below */
    --sprite-total: 100vh;
    --sprite-hidden-below: 10vh;
  }
  *{box-sizing:border-box;font-family:Inter, "Segoe UI", Roboto, system-ui, sans-serif}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg-dark) 0%, var(--bg-mid) 50%, var(--bg-light) 100%);color:var(--text);overflow:hidden}
  .stage{position:relative;width:100%;height:100vh;overflow:hidden}

  /* Background layers - Fixed aspect ratio */
  .bg{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;background-size:cover;background-position:center;transition:opacity .9s ease, filter .9s ease;opacity:0;filter:blur(0px);z-index:0}
  .bg.show{opacity:1}

  /* cinematic lines */
  .cinematic{position:absolute;left:50%;top:12%;transform:translateX(-50%);text-align:center;z-index:7;pointer-events:none}
  .cine-line{font-size:1.25rem;max-width:1100px;color:rgba(255,255,255,0.95);opacity:0;transform:translateY(12px);transition:all .85s ease}

  /* sprites with animations - Responsive sizing */
  .sprite{position:absolute;bottom:calc(0px - var(--sprite-hidden-below));z-index:5;transition:all .6s ease;pointer-events:none;opacity:0;visibility:hidden;filter: brightness(0.7);height:var(--sprite-total);width:auto;}
  .sprite.show{opacity:1;visibility:visible}
  .sprite.player{left:28px}
  .sprite.apsara{left:50%;transform:translateX(-50%)}
  .sprite.gandharva{right:28px}
  .sprite.center{left:50%;transform:translateX(-50%)}
  
  /* Breathing animation - for sprites without horizontal transform */
  @keyframes breathing {
    0% { transform: translateY(0) scale(1); }
    50% { transform: translateY(-5px) scale(1.02); }
    100% { transform: translateY(0) scale(1); }
  }
  
  /* Breathing animation - for centered sprites (with translateX) */
  @keyframes breathingCentered {
    0% { transform: translateX(-50%) translateY(0) scale(1); }
    50% { transform: translateX(-50%) translateY(-5px) scale(1.02); }
    100% { transform: translateX(-50%) translateY(0) scale(1); }
  }
  
  .sprite.breathing {
    animation: breathing 4s ease-in-out infinite;
  }
  
  /* Apply centered breathing animation to sprites that need horizontal centering */
  .sprite.apsara.breathing,
  .sprite.center.breathing {
    animation: breathingCentered 4s ease-in-out infinite;
  }
  
  /* Speaking highlight - Simple brightness adjustment */
  .sprite.speaking {
    filter: brightness(1.05);
  }
  
  .sprite.non-speaking {
    filter: brightness(0.95);
  }
  
  /* Emotion effects - NO HUE CHANGES, only brightness adjustments */
  .sprite.happy {
    filter: brightness(1.1);
  }
  
  .sprite.serious {
    filter: brightness(0.9);
  }
  
  .sprite.thoughtful {
    filter: brightness(1.05);
  }

  /* dialogue */
  .dialogue{position:absolute;left:20px;right:20px;bottom:18px;height:clamp(180px,20vh,260px);background:var(--panel);border-radius:12px;padding:16px;display:flex;flex-direction:column;gap:8px;z-index:9;border:1px solid rgba(255,255,255,0.04);backdrop-filter: blur(6px)}
  .speaker{font-weight:700;color:var(--accent);font-size:1.2rem}
  .text{flex:1;font-size:1.05rem;line-height:1.45;color:var(--text);white-space:pre-wrap;padding-left:12px;border-left:3px solid rgba(255,215,0,0.12);overflow:auto}
  .controls{display:flex;justify-content:space-between;align-items:center;gap:8px}
  .btn{background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.04);padding:10px 12px;border-radius:8px;color:var(--text);cursor:pointer;font-weight:700}
  .btn:hover{background:rgba(74,144,226,0.14);border-color:var(--primary)}

  /* choices overlay */
  .choices{position:absolute;left:50%;top:48%;transform:translate(-50%,-50%);z-index:12;background:var(--panel);padding:18px;border-radius:10px;display:none;min-width:420px;box-shadow:0 10px 40px rgba(0,0,0,0.6)}
  .choices.show{display:block}
  .choice-grid{display:grid;grid-template-columns:1fr;gap:12px}
  .choice{padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:rgba(255,255,255,0.02);cursor:pointer;font-weight:700}
  .choice:hover{background:rgba(74,144,226,0.14)}

  /* Enhanced puzzle styles */
  .mantra-puzzle {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    justify-content: center;
    align-items: center;
    padding: 12px;
    max-width: 500px;
    margin: 0 auto;
  }
  
  .puzzle-hint {
    background: rgba(255, 215, 0, 0.1);
    border: 1px dashed rgba(255, 215, 0, 0.3);
    padding: 8px;
    border-radius: 6px;
    margin-top: 10px;
    font-size: 0.9rem;
    color: rgba(255, 255, 255, 0.8);
    text-align: center;
  }
  
  .hymn-display {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 15px;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }
  
  .hymn-title {
    color: var(--accent);
    font-weight: bold;
    margin-bottom: 8px;
    font-size: 1.1rem;
  }
  
  .hymn-sanskrit {
    font-style: italic;
    margin-bottom: 8px;
    line-height: 1.5;
  }
  
  .hymn-translation {
    font-size: 0.95rem;
    color: rgba(255, 255, 255, 0.9);
    margin-bottom: 10px;
    line-height: 1.4;
  }
  
  .meaning-modal {
    max-width: 700px;
    width: 90%;
  }
  
  .meaning-content {
    max-height: 70vh;
    overflow-y: auto;
    padding-right: 10px;
  }
  
  .meaning-section {
    margin-bottom: 15px;
  }
  
  .meaning-section h4 {
    color: var(--accent);
    margin-bottom: 5px;
  }
  
  .deity-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 8px;
  }
  
  .deity-tag {
    background: rgba(74, 144, 226, 0.2);
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.85rem;
  }
  
  .theme-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 8px;
  }
  
  .theme-tag {
    background: rgba(255, 215, 0, 0.15);
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.85rem;
  }
  
  .puzzle-controls {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-top: 15px;
  }
  
  .hint-btn {
    background: rgba(255, 215, 0, 0.15);
    border: 1px solid rgba(255, 215, 0, 0.3);
  }
  
  .hint-btn:hover {
    background: rgba(255, 215, 0, 0.25);
  }
  
  .skip-btn {
    background: rgba(255, 100, 100, 0.15);
    border: 1px solid rgba(255, 100, 100, 0.3);
  }
  
  .skip-btn:hover {
    background: rgba(255, 100, 100, 0.25);
  }

  /* HUD */
  .hud{position:fixed;left:18px;top:18px;background:var(--glass);padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);z-index:11}
  .hud .line{font-size:0.95rem}
  
  /* Hymn Info HUD */
  .hymn-info{position:fixed;right:18px;top:18px;background:var(--glass);padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);z-index:11}
  .hymn-info .line{font-size:0.95rem}
  .hymn-info .mantra{font-style:italic;color:var(--accent);margin-top:4px}

  /* FABs */
  .fab{position:fixed;right:18px;width:48px;height:48px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:none;background:var(--primary);color:#fff;cursor:pointer;box-shadow:0 10px 30px rgba(0,0,0,0.35);z-index:11}
  #menuBtn{bottom:18px} #codexBtn{bottom:86px} #saveBtn{bottom:154px} #vnMenuBtn{bottom:224px}

  /* modals */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,0.7);display:none;align-items:center;justify-content:center;z-index:20}
  .modal.show{display:flex}
  .panel{background:linear-gradient(180deg, rgba(12,10,30,0.98), rgba(18,16,40,0.98));padding:18px;border-radius:10px;max-width:90%;max-height:86%;overflow:auto;border:1px solid rgba(255,255,255,0.03);color:var(--text)}
  .panel h3{margin:0 0 10px 0;color:var(--accent)}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;margin-top:12px}

  /* toast */
  #toast{position:fixed;right:18px;top:18px;background:rgba(0,0,0,0.6);padding:8px 12px;border-radius:8px;color:#fff;z-index:22;display:none}

  /* Glyph styles for puzzle */
  .glyph {
    width: 80px;
    height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.2s ease;
  }

  .glyph:hover {
    background: rgba(74, 144, 226, 0.2);
    transform: scale(1.05);
  }

  .glyph.selected {
    background: rgba(255, 215, 0, 0.2);
    border-color: rgba(255, 215, 0, 0.5);
  }

  /* VN Menu Overlay - will be created by menuOverlay.js */
  #vnOverlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.75);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 30;
    backdrop-filter: blur(2px);
  }
  
  #vnPanel {
    background: linear-gradient(180deg, rgba(12,10,30,0.98), rgba(18,16,40,0.98));
    padding: 24px;
    border-radius: 12px;
    max-width: 420px;
    width: 90%;
    border: 1px solid rgba(255,255,255,0.06);
    color: white;
    box-shadow: 0 12px 40px rgba(0,0,0,0.5);
    font-family: Inter, "Segoe UI", Roboto, system-ui, sans-serif;
  }
  
  #vnTitle {
    margin: 0 0 20px 0;
    color: var(--accent);
    text-align: center;
    font-size: 1.6rem;
  }
  
  #vnBtnGrid {
    display: grid;
    gap: 12px;
  }
  
  /* Settings Panel Styles */
  .settings-group {
    margin-bottom: 20px;
  }
  
  .settings-group h4 {
    color: var(--accent);
    margin-bottom: 10px;
    font-size: 1.1rem;
  }
  
  .settings-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
  }
  
  .slider {
    width: 150px;
    height: 6px;
    border-radius: 3px;
    background: rgba(255, 255, 255, 0.2);
    outline: none;
    -webkit-appearance: none;
    appearance: none;
  }
  
  .slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
  }
  
  .slider::-moz-range-thumb {
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
    border: none;
  }
  
  .toggle-switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 24px;
  }
  
  .toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }
  
  .toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(255, 255, 255, 0.2);
    transition: .4s;
    border-radius: 24px;
  }
  
  .toggle-slider:before {
    position: absolute;
    content: "";
    height: 16px;
    width: 16px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
  }
  
  input:checked + .toggle-slider {
    background-color: var(--accent);
  }
  
  input:checked + .toggle-slider:before {
    transform: translateX(26px);
  }
  
  /* Save/Load Slots */
  .save-slots {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin-top: 15px;
  }
  
  .save-slot {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .save-slot:hover {
    background: rgba(74, 144, 226, 0.2);
  }
  
  .save-slot-title {
    font-weight: bold;
    margin-bottom: 5px;
    color: var(--accent);
  }
  
  .save-slot-info {
    font-size: 0.85rem;
    color: rgba(255, 255, 255, 0.7);
  }
  
  /* Gallery Grid */
  .gallery-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin-top: 15px;
  }
  
  .gallery-item {
    aspect-ratio: 16/9;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    overflow: hidden;
    position: relative;
    cursor: pointer;
  }
  
  .gallery-item.locked {
    display: flex;
    align-items: center;
    justify-content: center;
    color: rgba(255, 255, 255, 0.5);
  }
  
  /* Splash Screen */
  #splash{
    position:fixed;inset:0;z-index:40;display:flex;flex-direction:column;align-items:center;justify-content:center;
    background: url('bg/Library of Hymns.jpg') center/cover no-repeat;
    text-align:center;padding:24px;
  }
  #splash:before{
    content:'';position:absolute;inset:0;background:linear-gradient(180deg, rgba(10,8,26,0.85), rgba(18,16,40,0.85));
  }
  #splash > *{position:relative}
  .splash-title{font-size:2rem;margin:0 0 10px 0;color:var(--accent)}
  .splash-sub{opacity:0.85;margin:0 0 20px 0}
  .fade-in{opacity:0;transform:translateY(6px);transition:all .6s ease}
  .fade-in.show{opacity:1;transform:translateY(0)}
  .splash-actions{display:flex;gap:12px;justify-content:center}
  
  .gallery-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  /* Achievements */
  .achievement-list {
    display: grid;
    gap: 12px;
    margin-top: 15px;
  }
  
  .achievement {
    display: flex;
    align-items: center;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 12px;
  }
  
  .achievement-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--accent);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 12px;
    font-size: 1.2rem;
  }
  
  .achievement-info {
    flex: 1;
  }
  
  .achievement-title {
    font-weight: bold;
    margin-bottom: 4px;
  }
  
  .achievement-desc {
    font-size: 0.85rem;
    color: rgba(255, 255, 255, 0.7);
  }
  
  .achievement.locked .achievement-icon {
    background: rgba(255, 255, 255, 0.2);
  }
  
  .achievement.locked .achievement-title,
  .achievement.locked .achievement-desc {
    color: rgba(255, 255, 255, 0.5);
  }

  @media (max-width:800px){
    .sprite.player{left:6px}
    .sprite{height:calc(var(--sprite-total) - 6vh)}
    .dialogue{left:10px;right:10px}
    .choices{min-width:320px}
    .hymn-info{font-size:0.85rem}
  }
  
  @media (max-width: 600px) {
    
    .mantra-puzzle {
      gap: 8px;
    }
    
    .glyph {
      width: 60px;
      height: 60px;
      font-size: 0.9rem;
    }
    
    .choices {
      min-width: 280px;
      padding: 12px;
    }
    
    .dialogue {
      height: clamp(160px, 22vh, 220px);
      padding: 12px;
    }
    
    .speaker {
      font-size: 1rem;
    }
    
    .text {
      font-size: 0.95rem;
    }
    
    #vnPanel {
      max-width: 90%;
      padding: 16px;
    }
    
    #vnTitle {
      font-size: 1.4rem;
    }
    
    .save-slots {
      grid-template-columns: 1fr;
    }
    
    .gallery-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }
</style>
</head>
<body>

  <!-- Splash Screen -->
  <div id="splash">
    <div class="panel" style="background:linear-gradient(180deg, rgba(12,10,30,0.86), rgba(18,16,40,0.86));border:1px solid rgba(255,255,255,0.08);max-width:720px;width:92%">
      <h1 class="splash-title">·πöta's Whisper</h1>
      <div class="splash-sub">Mandala I ‚Äî A brief prologue</div>
      <div id="splashIntro1" class="fade-in" style="margin-top:10px">In the stillness before sound, a glow gathers ‚Äî waiting.</div>
      <div id="splashIntro2" class="fade-in" style="margin-top:8px">Listen. When you are ready, begin your step into the hymn.</div>
      <div style="margin-top:18px" class="splash-actions">
        <button id="startBtn" class="btn" style="display:none;padding:12px 18px;font-size:1rem">Start ‚ñ∂</button>
      </div>
    </div>
  </div>

  
  <div class="stage" id="stage">

    <!-- BACKGROUNDS (evolving layers with images) -->
    <img id="bgSilence" class="bg show" src="bg/Pure Void of Creation.png" alt="Silence">
    <img id="bgWhisper" class="bg" src="bg/Creation_Void.jpg" alt="Whisper Flame">
    <img id="bgAwaken" class="bg" src="bg/Vedic Ether Realm.png" alt="Awaken">
    <img id="bgIgnite" class="bg" src="bg/invication_alter.jpg" alt="Ignite">
    <img id="bgAgni" class="bg" src="bg/Realm_Agni.jpg" alt="Agni Realm">

     <!-- Additional Background Assets with ids/classes (hidden until shown) -->
     <img id="bgAgniBirth" class="bg" src="bg/agni_birth.jpg" alt="Agni Birth">
     <img id="bgApsaraBg" class="bg" src="bg/apsara_bg.jpg" alt="Apsara BG">
     <img id="bgBlueWhiteMeditationVoid" class="bg" src="bg/Blue-White Meditation Void.png" alt="Meditation Void">
     <img id="bgCave" class="bg" src="bg/cave.jpg" alt="Cave">
     <img id="bgCelestialGrayLotusChamber" class="bg" src="bg/Celestial Gray Lotus Chamber.png" alt="Lotus Chamber">
     <img id="bgCosmicBalance" class="bg" src="bg/Cosmic_Balance.jpg" alt="Cosmic Balance">
     <img id="bgDialogue" class="bg" src="bg/Dialogue_bg.jpg" alt="Dialogue BG">
     <img id="bgEarthyRitualGrayPlain" class="bg" src="bg/Earthy Ritual Gray Plain.png" alt="Ritual Plain">
     <img id="bgFestivalOfJoy" class="bg" src="bg/Festival_of_Joy.jpg" alt="Festival of Joy">
     <img id="bgGandharvaBg" class="bg" src="bg/gandharva_bg.png" alt="Gandharva BG">
     <img id="bgGoldenHorizonHalo" class="bg" src="bg/Golden Horizon Halo.png" alt="Golden Horizon">
     <img id="bgHeroicMindBattlefield" class="bg" src="bg/Heroic_Mind_Battlefield.jpg" alt="Mind Battlefield">
     <img id="bgHumanHarmonyRealm" class="bg" src="bg/Human_Harmony_realm.jpg" alt="Human Harmony">
     <img id="bgIndraThunder1" class="bg" src="bg/indra_thunder1 .png" alt="Indra Thunder">
     <img id="bgLibraryOfHymns" class="bg" src="bg/Library of Hymns.jpg" alt="Library of Hymns">
     <img id="bgMeditationArea" class="bg" src="bg/Meditation_Area.jpg" alt="Meditation Area">
     <img id="bgPaleGoldAuraRoom" class="bg" src="bg/Pale Gold Aura Room.png" alt="Pale Gold Aura Room">
     <img id="bgPrismaticMantraField" class="bg" src="bg/Prismatic Mantra Field.png" alt="Prismatic Mantra Field">
     <img id="bgRitualAndOrder" class="bg" src="bg/Ritual_&_Order.jpg" alt="Ritual and Order">
     <img id="bgRiverOfDeities" class="bg" src="bg/River_of_Deities.jpg" alt="River of Deities">
     <img id="bgShadowVoidFlashbacks" class="bg" src="bg/Shadow Void for Flashbacks.png" alt="Shadow Void">
     <img id="bgSilverMistSpace" class="bg" src="bg/Silver Mist Space.png" alt="Silver Mist Space">
     <img id="bgSkyOfWinds" class="bg" src="bg/Sky_of_Winds.jpg" alt="Sky of Winds">
     <img id="bgSomaDreamRealm" class="bg" src="bg/Soma_Dream_Realm.jpg" alt="Soma Dream Realm">
     <img id="bgSpaceVoid" class="bg" src="bg/space void.png" alt="Space Void">
     <img id="bgTransition" class="bg" src="bg/Transition.jpg" alt="Transition">
     <img id="bgUniversalBalanceRoom" class="bg" src="bg/Universal Balance Room.png" alt="Universal Balance Room">
     <img id="bgWhiteLightChamber" class="bg" src="bg/White Light Chamber.png" alt="White Light Chamber">
 

    <!-- Cinematic text -->
    <div class="cinematic" id="cinematic">
      <div id="cine1" class="cine-line">In the beginning, there was no earth, no sky. Only silence ‚Äî breathing light within itself.</div>
      <div id="cine2" class="cine-line">From that silence came a whisper. From whisper ‚Äî flame. And from flame ‚Äî the hymn.</div>
      <div id="cine3" class="cine-line">You awaken where verses are born ‚Äî the Ether of ·πöta. Your memory is smoke. Your name, unknown.</div>
      <div id="cine4" class="cine-line">A voice sings through the light ‚Äî delicate, ancient.</div>
    </div>

    <!-- Sprites -->
    <img id="player" class="sprite player" src="sprite/player/player_F_neutral_serene_s1.png" alt="Player">
    <img id="apsara" class="sprite apsara" src="sprite/apa/apsara_Stand_Neutral.png.png" alt="Apsara">
    <img id="gandharva" class="sprite gandharva" src="sprite/gan/gandharva_Stand_Neutral.png.png" alt="Gandharva">
    <!-- Additional Sprite Poses with ids/classes (hidden until shown) -->
    <!-- Apsara variants -->
    <img id="apsaraBlessingPeace" class="sprite apsara" src="sprite/apa/apsara_blessing_peace.png" alt="Apsara Blessing Peace">
    <img id="apsaraGuidingGlow" class="sprite apsara" src="sprite/apa/apsara_guiding_glow.png" alt="Apsara Guiding Glow">
    <img id="apsaraListeningPose" class="sprite apsara" src="sprite/apa/apsara_Listening Pose.png" alt="Apsara Listening Pose">
    <img id="apsaraListeningSerene" class="sprite apsara" src="sprite/apa/apsara_listening_serene.png" alt="Apsara Listening Serene">
    <img id="apsaraProtectiveAura" class="sprite apsara" src="sprite/apa/apsara_protective_aura.png" alt="Apsara Protective Aura">
    <img id="apsaraRevelationLight" class="sprite apsara" src="sprite/apa/apsara_revelation_light.png" alt="Apsara Revelation Light">
    <img id="apsaraReverentPose" class="sprite apsara" src="sprite/apa/apsara_Reverent_Pose.png" alt="Apsara Reverent Pose">
    <img id="apsaraTeachingPose" class="sprite apsara" src="sprite/apa/apsara_Teaching _Pose.png" alt="Apsara Teaching Pose">
    <img id="apsaraAlt8" class="sprite apsara" src="sprite/apa/apsara (8).png" alt="Apsara Alt 8">
    <!-- Gandharva variants -->
    <img id="gandharvaBlessingLight" class="sprite gandharva" src="sprite/gan/gandharva_blessing_light.png" alt="Gandharva Blessing Light">
    <img id="gandharvaContemplativeCalm" class="sprite gandharva" src="sprite/gan/gandharva_contemplative_calm.png" alt="Gandharva Contemplative Calm">
    <img id="gandharvaExplainingPose" class="sprite gandharva" src="sprite/gan/gandharva_Explaining Pose.png" alt="Gandharva Explaining Pose">
    <img id="gandharvaGuiding" class="sprite gandharva" src="sprite/gan/gandharva_guiding.png" alt="Gandharva Guiding">
    <img id="gandharvaListeningPose" class="sprite gandharva" src="sprite/gan/gandharva_Listening Pose.png" alt="Gandharva Listening Pose">
    <img id="gandharvaListeningSerene" class="sprite gandharva" src="sprite/gan/gandharva_listening_serene.png" alt="Gandharva Listening Serene">
    <img id="gandharvaResonanceAura" class="sprite gandharva" src="sprite/gan/gandharva_resonance_aura.png" alt="Gandharva Resonance Aura">
    <img id="gandharvaSilentObserve" class="sprite gandharva" src="sprite/gan/gandharva_silent_observe.png" alt="Gandharva Silent Observe">
    <img id="gandharvaTeachingGesture" class="sprite gandharva" src="sprite/gan/gandharva_teaching_gesture.png" alt="Gandharva Teaching Gesture">

    <!-- Dialogue -->
    <div class="dialogue" id="dialogue">
      <div class="speaker" id="speaker">-</div>
      <div class="text" id="dialogueText"> </div>
      <div class="controls">
        <div style="display:flex;gap:8px">
          <button class="btn" id="autoBtn" title="Toggle auto-advance">‚ñ∂ Auto</button>
          <button class="btn" id="skipBtn" title="Skip current scene">Skip</button>
        </div>
        <div>
          <button class="btn" id="backBtn">‚Ü© Back</button>
          <button class="btn" id="nextBtn">Next ‚ñ∂</button>
        </div>
      </div>
    </div>

    <!-- Choices (generic overlay used by engine) -->
    <div class="choices" id="choices">
      <div style="text-align:center;margin-bottom:10px;color:var(--accent);font-weight:800;" id="choiceTitle">Choose your approach</div>
      <div class="choice-grid" id="choiceGrid"></div>
    </div>

    <!-- Enhanced Mantra puzzle -->
    <div class="choices" id="puzzle" style="min-width:560px">
      <div style="text-align:center;margin-bottom:10px;color:var(--accent);font-weight:800;">Align the glyphs to feel the verse</div>
      
      <!-- Hymn Display Section -->
      <div class="hymn-display">
        <div class="hymn-title" id="currentHymnTitle">Hymn 1.1: Agni</div>
        <div class="hymn-sanskrit" id="currentHymnSanskrit">agnim ƒ´·∏∑e purohitam yaj√±asya devam ·πõtvijam | hotƒÅra·πÉ ratnadhƒÅtamam ||</div>
        <div class="hymn-translation" id="currentHymnTranslation">I laud Agni, the chosen Priest, God, minister of sacrifice...</div>
        <button class="btn" id="showMeaningBtn" style="margin-top:8px">Show Detailed Meaning</button>
      </div>
      
      <div class="mantra-puzzle" id="mantraGrid"></div>
      
      <div class="puzzle-hint" id="puzzleHint">Select the glyphs in the correct order to form the mantra</div>
      
      <div class="puzzle-controls">
        <button class="btn hint-btn" id="puzzleHintBtn">Get Hint</button>
        <button class="btn" id="puzzleSubmit">Submit</button>
        <button class="btn skip-btn" id="puzzleSkipBtn">Skip Puzzle</button>
      </div>
    </div>

    <!-- Meaning Modal -->
    <div class="modal" id="meaningModal">
      <div class="panel meaning-modal">
        <h3 id="meaningTitle">Hymn 1.1: Agni</h3>
        <div class="meaning-content">
          <div class="meaning-section">
            <h4>Sanskrit</h4>
            <div id="meaningSanskrit" style="font-style: italic; line-height: 1.6;"></div>
          </div>
          
          <div class="meaning-section">
            <h4>Translation</h4>
            <div id="meaningTranslation" style="line-height: 1.5;"></div>
          </div>
          
          <div class="meaning-section">
            <h4>Explanation</h4>
            <div id="meaningExplanation" style="line-height: 1.5;"></div>
          </div>
          
          <div class="meaning-section">
            <h4>Deities</h4>
            <div id="meaningDeities" class="deity-tags"></div>
          </div>
          
          <div class="meaning-section">
            <h4>Themes</h4>
            <div id="meaningThemes" class="theme-tags"></div>
          </div>
        </div>
        
        <div style="text-align:right;margin-top:15px">
          <button class="btn" id="closeMeaningBtn">Close</button>
        </div>
      </div>
    </div>

    <!-- HUD -->
    <div class="hud" id="hud">
      <div class="line">Heart: <span id="heart">0</span> &nbsp;‚Ä¢&nbsp; Mind: <span id="mind">0</span> &nbsp;‚Ä¢&nbsp; Synth: <span id="balance">0</span></div>
      <div style="font-size:0.85rem;margin-top:6px">Mandala: <span id="mandalaName">‚Äî</span></div>
    </div>
    
    <!-- Hymn Info HUD -->
    <div class="hymn-info" id="hymnInfo">
      <div class="line">Hymn: <span id="currentHymnIndex">1.1</span></div>
      <div class="mantra" id="currentMantra">Agni·πÅ ƒ´·∏∑e purohita·πÅ</div>
    </div>

    <!-- FABs -->
    <button class="fab" id="menuBtn" title="Mandala Menu">üåå</button>
    <button class="fab" id="codexBtn" title="Codex" style="right:18px;bottom:86px">üìú</button>
    <button class="fab" id="saveBtn" title="Save" style="right:18px;bottom:154px">üíæ</button>
    <button class="fab" id="vnMenuBtn" title="Menu">üìã</button>

    <!-- Modals: Menu, Codex -->
    <div class="modal" id="menuModal">
      <div class="panel">
        <h3>·πöta ‚Äî Mandala Menu</h3>
        <div style="margin-top:10px">Choose your destination (Mandala I is unlocked):</div>
        <div class="grid" id="menuGrid" style="margin-top:12px"></div>
        <div style="text-align:right;margin-top:12px">
          <button class="btn" id="closeMenuBtn">Close</button>
        </div>
      </div>
    </div>

    <div class="modal" id="codexModal">
      <div class="panel">
        <h3>Codex of ·πöta</h3>
        <div id="codexEntries" style="margin-top:10px">No entries yet. Explore Mandala I to unlock hymns and notes.</div>
        <div style="text-align:right;margin-top:12px">
          <button class="btn" id="closeCodexBtn">Close</button>
        </div>
      </div>
    </div>

    <!-- VN Menu Overlay - will be created by menuOverlay.js -->
    <div id="vnOverlay"></div>

    <!-- toast -->
    <div id="toast"></div>
  </div>

<script>
/* ---------- STATE ---------- */
const state = {
  currentScene: 'intro_cinematic', // controls higher-level flow
  mandala: 0,
  heart: 0,
  mind: 0,
  unity: 0, // Added for Unity affinity
  codex: {},
  gallery: {},
  autosaveKey: 'rta_autosave_v1',
  saveKey: 'rta_save_v1',
  currentHymn: "1.1",
  currentMantra: "Agni·πÅ ƒ´·∏∑e purohita·πÅ",
  importantScenes: ['intro_cinematic', 'mandala1_conclude', 'mandala1_deep_question'],
  // Settings
  settings: {
    textSpeed: 35,
    autoPlaySpeed: 1500,
    bgmVolume: 70,
    sfxVolume: 80,
    voiceVolume: 90,
    autoAdvance: false,
    skipUnread: false
  },
  // Achievements
  achievements: {
    firstSteps: { unlocked: false, title: "First Steps", desc: "Begin your journey in the Ether of ·πöta" },
    flameSeeker: { unlocked: false, title: "Flame Seeker", desc: "Complete the first Mandala" },
    heartPath: { unlocked: false, title: "Path of Heart", desc: "Follow the path of emotion and feeling" },
    mindPath: { unlocked: false, title: "Path of Mind", desc: "Follow the path of logic and thought" },
    unityPath: { unlocked: false, title: "Path of Unity", desc: "Find balance between heart and mind" },
    puzzleMaster: { unlocked: false, title: "Puzzle Master", desc: "Complete the mantra puzzle without hints" },
    scholar: { unlocked: false, title: "Scholar", desc: "Unlock all codex entries in Mandala I" },
    debateMaster: { unlocked: false, title: "Debate Master", desc: "Choose Synthesize 50 times across hymns" },
    rtaWeaver: { unlocked: false, title: "·πõta Weaver", desc: "Reach the balanced ending at 1.191" }
  },
  // Gallery
  unlockedCGs: [],
  // Illusions
  unlockedIllusions: []
};

/* ---------- DOM ---------- */
const bgSilence = document.getElementById('bgSilence');
const bgWhisper = document.getElementById('bgWhisper');
const bgAwaken = document.getElementById('bgAwaken');
const bgIgnite = document.getElementById('bgIgnite');
const bgAgni = document.getElementById('bgAgni');
// Additional background elements
const bgAgniBirth = document.getElementById('bgAgniBirth');
const bgApsaraBg = document.getElementById('bgApsaraBg');
const bgBlueWhiteMeditationVoid = document.getElementById('bgBlueWhiteMeditationVoid');
const bgCave = document.getElementById('bgCave');
const bgCelestialGrayLotusChamber = document.getElementById('bgCelestialGrayLotusChamber');
const bgCosmicBalance = document.getElementById('bgCosmicBalance');
const bgDialogue = document.getElementById('bgDialogue');
const bgEarthyRitualGrayPlain = document.getElementById('bgEarthyRitualGrayPlain');
const bgFestivalOfJoy = document.getElementById('bgFestivalOfJoy');
const bgGandharvaBg = document.getElementById('bgGandharvaBg');
const bgGoldenHorizonHalo = document.getElementById('bgGoldenHorizonHalo');
const bgHeroicMindBattlefield = document.getElementById('bgHeroicMindBattlefield');
const bgHumanHarmonyRealm = document.getElementById('bgHumanHarmonyRealm');
const bgIndraThunder1 = document.getElementById('bgIndraThunder1');
const bgLibraryOfHymns = document.getElementById('bgLibraryOfHymns');
const bgMeditationArea = document.getElementById('bgMeditationArea');
const bgPaleGoldAuraRoom = document.getElementById('bgPaleGoldAuraRoom');
const bgPrismaticMantraField = document.getElementById('bgPrismaticMantraField');
const bgRitualAndOrder = document.getElementById('bgRitualAndOrder');
const bgRiverOfDeities = document.getElementById('bgRiverOfDeities');
const bgShadowVoidFlashbacks = document.getElementById('bgShadowVoidFlashbacks');
const bgSilverMistSpace = document.getElementById('bgSilverMistSpace');
const bgSkyOfWinds = document.getElementById('bgSkyOfWinds');
const bgSomaDreamRealm = document.getElementById('bgSomaDreamRealm');
const bgSpaceVoid = document.getElementById('bgSpaceVoid');
const bgTransition = document.getElementById('bgTransition');
const bgUniversalBalanceRoom = document.getElementById('bgUniversalBalanceRoom');
const bgWhiteLightChamber = document.getElementById('bgWhiteLightChamber');

const player = document.getElementById('player');
const apsara = document.getElementById('apsara');
const gandharva = document.getElementById('gandharva');
// Apsara sprite variants
const apsaraBlessingPeace = document.getElementById('apsaraBlessingPeace');
const apsaraGuidingGlow = document.getElementById('apsaraGuidingGlow');
const apsaraListeningPose = document.getElementById('apsaraListeningPose');
const apsaraListeningSerene = document.getElementById('apsaraListeningSerene');
const apsaraProtectiveAura = document.getElementById('apsaraProtectiveAura');
const apsaraRevelationLight = document.getElementById('apsaraRevelationLight');
const apsaraReverentPose = document.getElementById('apsaraReverentPose');
const apsaraTeachingPose = document.getElementById('apsaraTeachingPose');
// Gandharva sprite variants
const gandharvaBlessingLight = document.getElementById('gandharvaBlessingLight');
const gandharvaContemplativeCalm = document.getElementById('gandharvaContemplativeCalm');
const gandharvaExplainingPose = document.getElementById('gandharvaExplainingPose');
const gandharvaGuiding = document.getElementById('gandharvaGuiding');
const gandharvaListeningPose = document.getElementById('gandharvaListeningPose');
const gandharvaListeningSerene = document.getElementById('gandharvaListeningSerene');
const gandharvaResonanceAura = document.getElementById('gandharvaResonanceAura');
const gandharvaSilentObserve = document.getElementById('gandharvaSilentObserve');
const gandharvaTeachingGesture = document.getElementById('gandharvaTeachingGesture');

const speaker = document.getElementById('speaker');
const textBox = document.getElementById('dialogueText');
const nextBtn = document.getElementById('nextBtn');
const backBtn = document.getElementById('backBtn');
const choicesEl = document.getElementById('choices');
const choiceTitle = document.getElementById('choiceTitle');
const choiceGrid = document.getElementById('choiceGrid');
const puzzleEl = document.getElementById('puzzle');
const mantraGrid = document.getElementById('mantraGrid');
const puzzleSubmit = document.getElementById('puzzleSubmit');
const puzzleHintBtn = document.getElementById('puzzleHintBtn');
const puzzleSkipBtn = document.getElementById('puzzleSkipBtn');
const puzzleHint = document.getElementById('puzzleHint');
const showMeaningBtn = document.getElementById('showMeaningBtn');
const closeMeaningBtn = document.getElementById('closeMeaningBtn');

const hudHeart = document.getElementById('heart');
const hudMind = document.getElementById('mind');
const hudBalance = document.getElementById('balance');
const mandalaName = document.getElementById('mandalaName');

// Hymn Info HUD
const currentHymnIndex = document.getElementById('currentHymnIndex');
const currentMantra = document.getElementById('currentMantra');

const menuBtn = document.getElementById('menuBtn');
const codexBtn = document.getElementById('codexBtn');
const saveBtn = document.getElementById('saveBtn');
const menuModal = document.getElementById('menuModal');
const codexModal = document.getElementById('codexModal');
const meaningModal = document.getElementById('meaningModal');
const menuGrid = document.getElementById('menuGrid');
const codexEntries = document.getElementById('codexEntries');
const toast = document.getElementById('toast');
const closeMenuBtn = document.getElementById('closeMenuBtn');
const closeCodexBtn = document.getElementById('closeCodexBtn');

// VN Menu Elements
const vnMenuBtn = document.getElementById('vnMenuBtn');
const vnOverlay = document.getElementById('vnOverlay');

// Splash Elements
const splash = document.getElementById('splash');
const startBtn = document.getElementById('startBtn');
const splashIntro1 = document.getElementById('splashIntro1');
const splashIntro2 = document.getElementById('splashIntro2');


const cineEls = [
  document.getElementById('cine1'),
  document.getElementById('cine2'),
  document.getElementById('cine3'),
  document.getElementById('cine4')
];

/* ---------- HELPERS ---------- */
function show(el){ el.classList.add('show'); el.style.display = ''; }
function hide(el){ el.classList.remove('show'); el.style.display = 'none'; }
function toastMsg(msg, t=1600){ toast.style.display='block'; toast.textContent=msg; setTimeout(()=>toast.style.display='none',t); }
function sanitizeEnglish(input){
  try{
    if (!input) return '';
    let s = String(input);
    
    // First, normalize Unicode to decompose characters
    s = s.normalize('NFD');
    
    // Replace all em dashes, en dashes, and other dashes with regular dash
    s = s.replace(/[‚Äî‚Äì‚àí‚Äï]/g, '-');
    
    // Replace ellipsis and other dots
    s = s.replace(/[‚Ä¶‚ãØ]/g, '...');
    
    // Replace all smart quotes with regular quotes
    s = s.replace(/["""]/g, '"');
    s = s.replace(/[''']/g, "'");
    
    // Replace Sanskrit and special characters with ASCII equivalents
    s = s.replace(/·πöta/gi, 'Rta');
    s = s.replace(/·πõta/gi, 'rta');
    s = s.replace(/·πÅ|·πÉ/g, 'm');
    s = s.replace(/ƒ´|ƒ´/g, 'i');
    s = s.replace(/ƒÅ|ƒÅ/g, 'a');
    s = s.replace(/≈´|≈´/g, 'u');
    s = s.replace(/≈õ|≈õ/g, 's');
    s = s.replace(/·πá/g, 'n');
    s = s.replace(/·πõ/g, 'r');
    s = s.replace(/·πÖ/g, 'n');
    s = s.replace(/·∏∑/g, 'l');
    s = s.replace(/·∏∑e/g, 'le');
    s = s.replace(/ƒ´·∏∑e/g, 'ile');
    s = s.replace(/·πÉ/g, 'm');
    s = s.replace(/·∏•/g, 'h');
    s = s.replace(/·π≠/g, 't');
    s = s.replace(/·∏ç/g, 'd');
    s = s.replace(/·π¢/g, 'S');
    s = s.replace(/·π£/g, 's');
    
    // Remove all combining diacritical marks
    s = s.replace(/[\u0300-\u036f]/g, '');
    
    // Remove all non-ASCII characters (keep only printable ASCII: space to ~)
    s = s.replace(/[^\x20-\x7E]/g, '');
    
    // Clean up whitespace
    s = s.replace(/\s+/g, ' ');
    s = s.trim();
    
    return s;
  }catch(e){ 
    // Fallback: aggressive removal of all non-ASCII
    return String(input || '').replace(/[^\x20-\x7E]/g, '').trim();
  }
}
function updateHUD(){ 
  hudHeart.textContent = state.heart; 
  hudMind.textContent = state.mind; 
  hudBalance.textContent = state.unity; 
  mandalaName.textContent = state.mandala ? `Mandala ${state.mandala}` : '-'; 
}
function updateHymnInfo() {
  const hid = state.currentHymn || '';
  currentHymnIndex.textContent = hid;
  // Derive mantra from codex data when possible
  let mantraTxt = state.currentMantra || '';
  try{
    if (hid && window.codexData && window.codexData.mandalas && window.codexData.mandalas["1"] && window.codexData.mandalas["1"].hymns && window.codexData.mandalas["1"].hymns[hid]){
      const h = window.codexData.mandalas["1"].hymns[hid];
      // Use beginning of the Sanskrit line as mantra display
      mantraTxt = (h.sanskrit||'').split(/\s+/).slice(0,4).join(' ');
    }
  }catch(e){}
  currentMantra.textContent = sanitizeEnglish(mantraTxt || '');
}
function saveAuto(){ try{ localStorage.setItem(state.autosaveKey, JSON.stringify(state)); }catch(e){} }

/* ---------- SPRITE / BG helpers ---------- */
function showSprite(el){ 
  el.classList.add('show'); 
  el.style.opacity = 1; 
  el.style.visibility = 'visible';
  // Add breathing effect to visible sprites
  if (!el.classList.contains('breathing')) {
    el.classList.add('breathing');
  }
}
function hideSprite(el){ 
  el.classList.remove('show', 'breathing', 'speaking', 'non-speaking', 'happy', 'serious', 'thoughtful'); 
  el.style.opacity = 0; 
  el.style.visibility = 'hidden';
}
function switchBG(bgEl){ 
  // Accept either a DOM element or a string ID
  let bgElement = bgEl;
  if (typeof bgEl === 'string') {
    bgElement = document.getElementById(bgEl);
  }
  
  if (!bgElement) {
    console.warn('switchBG: Background element not found:', bgEl);
    return;
  }
  
  // Hide ALL backgrounds (not just the first 5)
  document.querySelectorAll('.bg').forEach(b => {
    b.classList.remove('show');
  });
  
  // Show the new background after a brief delay for smooth transition
  setTimeout(() => {
    if (bgElement) {
      bgElement.classList.add('show');
      // Ensure the element is visible
      bgElement.style.display = '';
      bgElement.style.opacity = '1';
      bgElement.style.visibility = 'visible';
    }
  }, 80); 
}

/* ---------- Sprite Switching Function ---------- */
function switchSprite(character, spriteVariant) {
  // Accept either a DOM element or a string ID
  let spriteElement = spriteVariant;
  if (typeof spriteVariant === 'string') {
    spriteElement = document.getElementById(spriteVariant);
  }
  
  if (!spriteElement) {
    console.warn('switchSprite: Sprite element not found:', spriteVariant);
    return;
  }
  
  // Hide ALL sprites of the same character type using CSS selector (more reliable)
  const characterClass = character === 'apsara' ? '.sprite.apsara' : '.sprite.gandharva';
  document.querySelectorAll(characterClass).forEach(sprite => {
    if (sprite && sprite !== spriteElement) {
      sprite.classList.remove('show', 'breathing', 'speaking', 'non-speaking', 'happy', 'serious', 'thoughtful');
      sprite.style.opacity = '0';
      sprite.style.visibility = 'hidden';
      sprite.style.display = 'none';
    }
  });
  
  // Show the new sprite immediately (no delay needed since we're hiding first)
  if (spriteElement) {
    spriteElement.style.display = '';
    spriteElement.style.opacity = '1';
    spriteElement.style.visibility = 'visible';
    spriteElement.classList.add('show');
    // Add breathing effect if not already present
    if (!spriteElement.classList.contains('breathing')) {
      spriteElement.classList.add('breathing');
    }
  }
}

/* ---------- Sprite Effects ---------- */
function setSpriteEmotion(sprite, emotion) {
  // Remove all emotion classes
  sprite.classList.remove('happy', 'serious', 'thoughtful');
  
  // Add the requested emotion class
  if (emotion) {
    sprite.classList.add(emotion);
  }
}

function highlightSpeaker(speakerName) {
  // Get all sprite variants
  const allApsaraSprites = [apsara, apsaraBlessingPeace, apsaraGuidingGlow, apsaraListeningPose, apsaraListeningSerene, apsaraProtectiveAura, apsaraRevelationLight, apsaraReverentPose, apsaraTeachingPose];
  const allGandharvaSprites = [gandharva, gandharvaBlessingLight, gandharvaContemplativeCalm, gandharvaExplainingPose, gandharvaGuiding, gandharvaListeningPose, gandharvaListeningSerene, gandharvaResonanceAura, gandharvaSilentObserve, gandharvaTeachingGesture];
  
  // Remove speaking and non-speaking classes from all sprites
  player.classList.remove('speaking', 'non-speaking');
  allApsaraSprites.forEach(s => { if (s) s.classList.remove('speaking', 'non-speaking'); });
  allGandharvaSprites.forEach(s => { if (s) s.classList.remove('speaking', 'non-speaking'); });
  
  // Add speaking class to the current speaker (find visible sprite)
  if (speakerName === 'Player' || speakerName === '???') {
    player.classList.add('speaking');
    allApsaraSprites.forEach(s => { if (s) s.classList.add('non-speaking'); });
    allGandharvaSprites.forEach(s => { if (s) s.classList.add('non-speaking'); });
  } else if (speakerName === 'Apsara') {
    // Find the currently visible Apsara sprite
    const visibleApsara = allApsaraSprites.find(s => s && s.classList.contains('show'));
    if (visibleApsara) visibleApsara.classList.add('speaking');
    player.classList.add('non-speaking');
    allGandharvaSprites.forEach(s => { if (s) s.classList.add('non-speaking'); });
  } else if (speakerName === 'Gandharva') {
    // Find the currently visible Gandharva sprite
    const visibleGandharva = allGandharvaSprites.find(s => s && s.classList.contains('show'));
    if (visibleGandharva) visibleGandharva.classList.add('speaking');
    player.classList.add('non-speaking');
    allApsaraSprites.forEach(s => { if (s) s.classList.add('non-speaking'); });
  }
  
  // Play sound effect (simulated)
  playCharacterSFX(speakerName);
}

function playCharacterSFX(character) {
  // In a real implementation, this would play actual sound files
  console.log(`Playing SFX for ${character}`);
  if (window.audio && window.audio.playChime) {
    window.audio.playChime(character);
  }
}

/* ---------- Typewriter Effect ---------- */
function setSpeaker(name) {
  speaker.textContent = name ? `- ${sanitizeEnglish(name)}` : '-';
  // Ensure the speaking character is visible
  if (name === 'Player' || name === '???') { showSprite(player); }
  else if (name === 'Apsara') { 
    // Find the currently visible Apsara sprite, or use default
    const visibleApsara = document.querySelector('.sprite.apsara.show');
    if (visibleApsara) {
      showSprite(visibleApsara);
    } else {
      switchSprite('apsara', apsara);
    }
  }
  else if (name === 'Gandharva') { 
    // Find the currently visible Gandharva sprite, or use default
    const visibleGandharva = document.querySelector('.sprite.gandharva.show');
    if (visibleGandharva) {
      showSprite(visibleGandharva);
    } else {
      switchSprite('gandharva', gandharva);
    }
  }
  highlightSpeaker(name);
}

function typeText(txt, callback) {
  // Clear the text box first
  if (!textBox) {
    console.error('textBox element not found');
    if (callback) callback();
    return;
  }
  
  textBox.textContent = "";
  
  // Sanitize to English-only ASCII for dialogue display
  let clean = sanitizeEnglish(txt || '');
  
  // Double-check: ensure only ASCII characters remain
  clean = clean.replace(/[^\x20-\x7E]/g, '');
  
  // Safety: if text is empty or corrupted, show error message
  if (!clean || clean.trim().length === 0) {
    console.warn('Empty or corrupted text detected:', txt);
    clean = '[Text unavailable]';
  }
  
  // Convert to array of characters
  const chars = Array.from(clean);
  let i = 0;
  
  // Clear any existing interval
  if (window.typeTextInterval) {
    clearInterval(window.typeTextInterval);
  }
  
  window.typeTextInterval = setInterval(() => {
    if (i < chars.length) {
      // Ensure each character is ASCII before adding
      const char = chars[i];
      if (char && char.charCodeAt(0) >= 32 && char.charCodeAt(0) <= 126) {
        textBox.textContent += char;
      }
      // Subtle typewriter blip every 3 characters
      if (window.audio && window.audio.playType && (i % 3 === 0)) {
        window.audio.playType();
      }
      i++;
    } else {
      clearInterval(window.typeTextInterval);
      window.typeTextInterval = null;
      if (callback) callback();
    }
  }, state.settings.textSpeed || 35);
}

/* ---------- SCENES (Provided by mandala1.js) ---------- */



/* ---------- Cinematic helpers ---------- */
function showCinematicLine(i){
  cineEls.forEach(e=>e.classList.remove('show'));
  setTimeout(()=> cineEls[i].classList.add('show'), 80);
}

/* ---------- Main scene engine (Enhanced with Typewriter and BG) ---------- */
let currentStepIndex = 0;
let currentSceneArray = (window.scenes && window.scenes.intro_cinematic) || [];

function enterScene(sceneKey){
  if (!window.scenes || !window.scenes[sceneKey]) return console.warn('Missing scene:', sceneKey);
  currentSceneArray = window.scenes[sceneKey];
  currentStepIndex = 0;
  state.currentScene = sceneKey;

  // Don't set hymn number here - let the scene actions set it to avoid timing issues
  // But initialize hymn info with current state
  updateHymnInfo();
  
  // Handle player visibility based on scene importance
  if (state.importantScenes.includes(sceneKey)) {
    showSprite(player);
  } else {
    hideSprite(player);
  }
  
  // Show back button only in mandala scenes
  if (sceneKey.startsWith('mandala')) {
    backBtn.style.display = '';
  } else {
    backBtn.style.display = 'none';
  }
  
  runStep();
}

function runStep(){
  const step = currentSceneArray[currentStepIndex];
  if (!step){
    onSceneEnd(state.currentScene);
    return;
  }
  
  // First, run the action (if any) to set up the scene
  // This will update state.currentHymn if needed
  if (step.action) step.action();
  
  // Update hymn info after action runs (in case hymn number changed)
  updateHymnInfo();
  
  // Then set the speaker and highlight
  setSpeaker(step.who);
  
  // Then type the text
  typeText(step.text, () => {
    nextBtn.disabled = false;
  });
}

/* Next / Back */
nextBtn.onclick = ()=>{
  if (choicesEl.classList.contains('show') || puzzleEl.classList.contains('show')) return;
  currentStepIndex++;
  if (currentStepIndex < currentSceneArray.length) runStep();
  else onSceneEnd(state.currentScene);
  nextBtn.disabled = true;
};
backBtn.onclick = ()=>{
  if (state.currentScene.startsWith('mandala1')) {
    enterScene('mandala1_reflection');
  } else {
    enterScene('intro_cinematic');
  }
};

/* ---------- Scene end routing ---------- */
function onSceneEnd(sceneKey){
  if (sceneKey === 'intro_cinematic'){
    state.mandala = 1;
    updateHUD();
    switchSprite('apsara', apsara); switchSprite('gandharva', gandharva);
    setTimeout(()=> enterScene('mandala1_opening'), 700);
    return;
  }
  // Auto-advance hymns: if a hymn scene ends, move to next hymn until 1.191
  if (sceneKey.startsWith('mandala1_hymn1_')){
    goToNextHymn();
    return;
  }
  // Only show completion after the actual conclusion scene, not during reflection/progression
  if (sceneKey === 'mandala1_conclusion'){
    showPostMandalaChoices();
    return;
  }
  // default: open menu
  showMenu();
}

/* ---------- Choices & UI (Enhanced with Unity) ---------- */

function showIntroChoice(){
  choicesEl.classList.add('show');
  choiceTitle.textContent = "Before we guide you through the Mandalas, tell us‚Ä¶";
  choiceGrid.innerHTML = '';
  addChoice('I seek to feel ‚Äî to understand through wonder. (Heart)', () => { applyAffinity('heart', 5); unlockAchievement('heartPath'); choicesEl.classList.remove('show'); enterScene('mandala1_opening'); });
  addChoice('I seek to know ‚Äî to understand through thought. (Mind)', () => { applyAffinity('mind', 5); unlockAchievement('mindPath'); choicesEl.classList.remove('show'); enterScene('mandala1_opening'); });
  addChoice('I seek balance ‚Äî both song and silence. (Unity)', () => { applyAffinity('unity', 5); unlockAchievement('unityPath'); choicesEl.classList.remove('show'); enterScene('mandala1_opening'); });
}

function showMandala1Approach(){
  choicesEl.classList.add('show');
  choiceTitle.textContent = "How will you approach this hymn?";
  choiceGrid.innerHTML = '';
  addChoice('The warmth within me rises ‚Äî I feel creation. (Heart)', () => { applyAffinity('heart', 10); addCodexEntry('mandala1_approach_heart'); choicesEl.classList.remove('show'); enterScene('mandala1_scene_ritual'); });
  addChoice('The words align ‚Äî I see structure and order. (Mind)', () => { applyAffinity('mind', 10); addCodexEntry('mandala1_approach_mind'); choicesEl.classList.remove('show'); enterScene('mandala1_scene_ritual'); });
  addChoice('Both ‚Äî harmony in heat and form. (Unity)', () => { applyAffinity('unity', 10); addCodexEntry('mandala1_approach_both'); choicesEl.classList.remove('show'); enterScene('mandala1_scene_ritual'); });
}

function showRitualChoice(){
  choicesEl.classList.add('show');
  choiceTitle.textContent = "You stand at the hearth. What do you offer?";
  choiceGrid.innerHTML = '';
  addChoice('A prayer from the chest (Heart)', () => { applyAffinity('heart',8); addCodexEntry('ritual_prayer'); choicesEl.classList.remove('show'); enterScene('mandala1_scene_soma'); });
  addChoice('A precise spoken verse (Mind)', () => { applyAffinity('mind',8); addCodexEntry('ritual_verse'); choicesEl.classList.remove('show'); enterScene('mandala1_scene_soma'); });
  addChoice('A silent offering (Unity)', () => { applyAffinity('unity',8); addCodexEntry('ritual_silence'); choicesEl.classList.remove('show'); enterScene('mandala1_scene_soma'); });
}

function showPostMandalaChoices(){
  choicesEl.classList.add('show');
  choiceTitle.textContent = "Mandala I complete: what will you do?";
  choiceGrid.innerHTML = '';
  addChoice('Return to Mandala Menu', () => { choicesEl.classList.remove('show'); showMenu(); });
  addChoice('Replay this Mandala (deeper)', () => { choicesEl.classList.remove('show'); enterScene('mandala1_opening'); });
  addChoice('Study Codex entries', () => { choicesEl.classList.remove('show'); openCodex(); });
}

function showDeepAnswerChoices(){
  choicesEl.classList.add('show');
  choiceTitle.textContent = "Answer from where you feel strongest:";
  choiceGrid.innerHTML = '';
  addChoice('I feel longing (Heart)', () => { applyAffinity('heart',12); addCodexEntry('deep_longing'); choicesEl.classList.remove('show'); enterScene('mandala1_conclude'); });
  addChoice('I reason through fear (Mind)', () => { applyAffinity('mind',12); addCodexEntry('deep_fear'); choicesEl.classList.remove('show'); enterScene('mandala1_conclude'); });
  addChoice('Both ‚Äî I want to understand why I long (Unity)', () => { applyAffinity('unity',12); addCodexEntry('deep_both'); choicesEl.classList.remove('show'); enterScene('mandala1_conclude'); });
}

function addChoice(label, cb){
  const d = document.createElement('div');
  d.className = 'choice';
  d.textContent = sanitizeEnglish(label);
  d.onclick = cb;
  choiceGrid.appendChild(d);
}

/* ---------- Affinity & Codex (Enhanced with Unity) ---------- */
function applyAffinity(type, amount){
  if (type === 'heart') state.heart += amount;
  if (type === 'mind') state.mind += amount;
  if (type === 'unity') state.unity += amount;
  updateHUD();
  saveAuto();
}

/* codex entries pool */
function addCodexEntry(id){
  const entries = {
    'mandala1_basic': { title:'Mandala I ‚Äî Agni (Intro)', text:'Agni as the connecting flame: messenger between earth and sky. Approach with offering.' },
    'mandala1_conclusion': { title:'Mandala I ‚Äî Reflection', text:'The flame you carry burns within: heat as remembrance, warmth as devotion.'},
    'mandala1_approach_heart': { title:'Mandala I ‚Äî Heart Note', text:'Feeling the hymn reveals its relational power: fire warms, remembers, binds.'},
    'mandala1_approach_mind': { title:'Mandala I ‚Äî Mind Note', text:'The hymn as structure: meter, sound, and function in ritual.'},
    'mandala1_approach_both': { title:'Mandala I ‚Äî Balanced Note', text:'Union of form and feeling ‚Äî ·πöta appears where both meet.'},
    'ritual_prayer': { title:'Ritual ‚Äî Prayer', text:'An offering that names the desire; a flame that sends words upward.'},
    'ritual_verse': { title:'Ritual ‚Äî Verse', text:'Structured sound shapes the passage between worlds.'},
    'ritual_silence': { title:'Ritual ‚Äî Silence', text:'Stillness can be an offering; attention itself becomes the hymn.'},
    'deep_longing': { title:'Deep ‚Äî Longing', text:'The Seeker who feels recognizes the flame as hearth of belonging.'},
    'deep_fear': { title:'Deep ‚Äî Fear', text:'The Seeker who reasons names the unknown to keep it near.'},
    'deep_both': { title:'Deep ‚Äî Both', text:'Integration: the final step to see ·πöta.'}
  };
  if (entries[id]) state.codex[id] = entries[id];
  updateCodexPanel();
  saveAuto();
  
  // Check for scholar achievement
  if (Object.keys(state.codex).length >= 10) {
    unlockAchievement('scholar');
  }
}

function updateCodexPanel(){
  codexEntries.innerHTML = '';
  const keys = Object.keys(state.codex);
  if (!keys.length){
    codexEntries.innerHTML = '<div>No entries yet. Explore Mandala I to unlock hymns and notes.</div>';
    return;
  }
  keys.forEach(k=>{
    const e = state.codex[k];
    const div = document.createElement('div');
    div.className = 'codex-entry';
    div.innerHTML = `<strong style="color:var(--accent)">${e.title}</strong><div style="margin-top:6px;font-size:0.98rem">${e.text}</div>`;
    codexEntries.appendChild(div);
  });
}

/* ---------- Codex Data (loaded from codex.json) ---------- */
let codexData = null;
function loadCodex(){
  try{
    fetch('codex.json').then(r=>r.json()).then(d=>{ codexData=d; window.codexData=d; }).catch(()=>{});
  }catch(e){}
}

/* ---------- Utilities ---------- */
function shuffleArray(a){ 
  for (let i=a.length-1;i>0;i--){ 
    const j=Math.floor(Math.random()*(i+1)); 
    [a[i],a[j]]=[a[j],a[i]] 
  } 
  return a; 
}

/* ---------- Hymn Progression ---------- */
function goToNextHymn(){
  try{
    // Calculate from current scene key to ensure accuracy
    const sceneKey = state.currentScene || '';
    let nextNum = 1;
    
    if (sceneKey && sceneKey.startsWith('mandala1_hymn1_')){
      const idx = sceneKey.split('_').pop();
      if (idx && !Number.isNaN(parseInt(idx,10))){
        nextNum = parseInt(idx,10) + 1;
      }
    } else {
      // Fallback: use state.currentHymn if available
      const hid = state.currentHymn || '1.1';
      const parts = hid.split('.');
      nextNum = parseInt(parts[1]||'1', 10) + 1;
    }
    
    if (nextNum <= 191){
      const key = `mandala1_hymn1_${nextNum}`;
      enterScene(key);
    } else {
      enterScene('mandala1_conclusion');
    }
  }catch(e){
    // Fallback: open menu if something goes wrong
    showMenu();
  }
}

/* ---------- Enhanced Mantra Puzzle ---------- */
const glyphPool = ['AN', 'GI', 'VA', 'SA', 'NA', 'RI'];
let selectedGlyphs = [];
let hintCount = 0;

function startMantraPuzzle(){
  puzzleEl.classList.add('show');
  
  // Display current hymn information
  const hid = state.currentHymn || '1.1';
  const hymn = (window.codexData && window.codexData.mandalas && window.codexData.mandalas["1"] && window.codexData.mandalas["1"].hymns && window.codexData.mandalas["1"].hymns[hid]) || null;
  if (hymn) {
    document.getElementById('currentHymnTitle').textContent = `Hymn ${hid}: ${(hymn.deities&&hymn.deities[0])||''}`;
    document.getElementById('currentHymnSanskrit').textContent = hymn.sanskrit;
    document.getElementById('currentHymnTranslation').textContent = (hymn.translation||'').substring(0, 80) + '...';
  } else {
    document.getElementById('currentHymnTitle').textContent = `Hymn ${hid}`;
  }
  
  // Setup meaning button
  showMeaningBtn.onclick = showMeaningModal;
  
  // Setup hint button
  puzzleHintBtn.onclick = provideHint;
  
  // Setup skip button
  puzzleSkipBtn.onclick = skipPuzzle;
  
  // Reset puzzle state
  const target = ['AN','GI','VA','SA'];
  const display = shuffleArray(glyphPool.slice()).slice(0,6);
  target.forEach(g=> { if (!display.includes(g)) display.push(g); });
  mantraGrid.innerHTML = '';
  selectedGlyphs = [];
  hintCount = 0;
  puzzleHint.textContent = 'Select the glyphs in the correct order to form the mantra';
  
  display.forEach(g=>{
    const el = document.createElement('div');
    el.className = 'glyph';
    el.textContent = g;
    el.onclick = () => {
      el.classList.toggle('selected');
      if (el.classList.contains('selected')) {
        selectedGlyphs.push(g);
      } else {
        selectedGlyphs = selectedGlyphs.filter(x=>x!==g);
      }
    };
    mantraGrid.appendChild(el);
  });

  puzzleSubmit.onclick = checkPuzzleSolution;
}

function provideHint() {
  const target = ['AN','GI','VA','SA'];
  
  if (hintCount < target.length) {
    const nextGlyph = target[hintCount];
    puzzleHint.textContent = `Hint: The next glyph is "${nextGlyph}"`;
    
    // Highlight the correct glyph
    const glyphs = document.querySelectorAll('.glyph');
    glyphs.forEach(glyph => {
      if (glyph.textContent === nextGlyph) {
        glyph.style.border = '2px solid rgba(255, 215, 0, 0.7)';
        glyph.style.boxShadow = '0 0 10px rgba(255, 215, 0, 0.5)';
      }
    });
    
    hintCount++;
  } else {
    puzzleHint.textContent = 'No more hints available. The sequence is: AN ‚Üí GI ‚Üí VA ‚Üí SA';
  }
}

function skipPuzzle() {
  puzzleEl.classList.remove('show');
  toastMsg('Puzzle skipped. Continuing to next hymn...');
  setTimeout(() => goToNextHymn(), 900);
}

function checkPuzzleSolution() {
  const chosen = selectedGlyphs.slice(0,4);
  const correct = JSON.stringify(chosen) === JSON.stringify(['AN','GI','VA','SA']);
  
  if (correct) {
    applyAffinity('heart', 6);
    applyAffinity('mind', 6);
    addCodexEntry('mandala1_basic');
    puzzleEl.classList.remove('show');
    
    // Check if puzzle was solved without hints
    if (hintCount === 0) {
      unlockAchievement('puzzleMaster');
    }
    
    toastMsg('You felt the meter ‚Äî advancing to the next hymn.');
    setTimeout(() => goToNextHymn(), 900);
  } else {
    puzzleHint.textContent = 'Incorrect sequence. Try again or use hints for assistance.';
    puzzleHint.style.color = 'rgba(255, 100, 100, 0.9)';
    
    // Reset color after a delay
    setTimeout(() => {
      puzzleHint.style.color = 'rgba(255, 255, 255, 0.8)';
    }, 3000);
  }
}

function showMeaningModal() {
  const hid = state.currentHymn || '1.1';
  const hymn = (window.codexData && window.codexData.mandalas && window.codexData.mandalas["1"] && window.codexData.mandalas["1"].hymns && window.codexData.mandalas["1"].hymns[hid]) || null;
  
  // Populate modal with hymn details
  if (hymn){
    document.getElementById('meaningTitle').textContent = `Hymn ${hid}: ${(hymn.deities&&hymn.deities[0])||''}`;
    document.getElementById('meaningSanskrit').textContent = hymn.sanskrit||'';
    document.getElementById('meaningTranslation').textContent = hymn.translation||'';
    document.getElementById('meaningExplanation').textContent = hymn.explanation||'';
  } else {
    document.getElementById('meaningTitle').textContent = `Hymn ${hid}`;
    document.getElementById('meaningSanskrit').textContent = '';
    document.getElementById('meaningTranslation').textContent = '';
    document.getElementById('meaningExplanation').textContent = '';
  }
  
  // Populate deities
  const deitiesContainer = document.getElementById('meaningDeities');
  deitiesContainer.innerHTML = '';
  if (hymn && hymn.deities) {
    hymn.deities.forEach(deity => {
      const tag = document.createElement('div');
      tag.className = 'deity-tag';
      tag.textContent = deity;
      deitiesContainer.appendChild(tag);
    });
  }
  
  // Populate themes
  const themesContainer = document.getElementById('meaningThemes');
  themesContainer.innerHTML = '';
  if (hymn && hymn.themes) {
    hymn.themes.forEach(theme => {
      const tag = document.createElement('div');
      tag.className = 'theme-tag';
      tag.textContent = theme;
      themesContainer.appendChild(tag);
    });
  }
  
  // Show modal
  meaningModal.classList.add('show');
}

function closeMeaningModal() {
  meaningModal.classList.remove('show');
}

/* ---------- Menu & Save/Load (preserved) ---------- */
function showMenu(){ 
  if (menuModal) {
    menuModal.classList.add('show'); 
    buildMenuGrid(); 
  } else {
    console.error('menuModal not found');
  }
}

function closeMenu(){ 
  if (menuModal) {
    menuModal.classList.remove('show'); 
  } else {
    console.error('menuModal not found');
  }
}

function openCodex(){ 
  if (codexModal) {
    codexModal.classList.add('show'); 
  } else {
    console.error('codexModal not found');
  }
}

function closeCodex(){ 
  if (codexModal) {
    codexModal.classList.remove('show'); 
  } else {
    console.error('codexModal not found');
  }
}

function buildMenuGrid(){
  if (!menuGrid) {
    console.error('menuGrid not found');
    return;
  }
  
  menuGrid.innerHTML = '';
  const entries = [
    { id:'mandala1', label:'Mandala I ‚Äî Agni (Unlocked)', action: ()=> { closeMenu(); enterScene('mandala1_opening'); } },
    { id:'mandala10', label:'Mandala X ‚Äî Creation (Locked)', action: ()=> { toastMsg('Locked ‚Äî progress through Mandalas to unlock.'); } }
  ];
  entries.forEach(e=>{
    const d = document.createElement('div');
    d.className = 'btn';
    d.style.padding = '12px';
    d.textContent = e.label;
    d.onclick = e.action;
    menuGrid.appendChild(d);
  });
}

/* Save & Load */
function doSave(){
  try{
    localStorage.setItem(state.saveKey, JSON.stringify(state));
    toastMsg('Game saved');
  }catch(e){ toastMsg('Save failed'); }
}
function doLoad(){
  try{
    const raw = localStorage.getItem(state.saveKey);
    if (!raw) { toastMsg('No saved game found'); return; }
    const parsed = JSON.parse(raw);
    Object.assign(state, parsed);
    updateHUD();
    updateHymnInfo();
    updateCodexPanel();
    if (state.currentScene) enterScene(state.currentScene);
    toastMsg('Game loaded');
  }catch(e){ toastMsg('Load failed'); }
}

/* ---------- Achievements ---------- */
function unlockAchievement(id) {
  if (state.achievements[id] && !state.achievements[id].unlocked) {
    state.achievements[id].unlocked = true;
    saveAuto();
    toastMsg(`Achievement Unlocked: ${state.achievements[id].title}`);
  }
}

/* ---------- Missing Choice Functions ---------- */
function showHymnChoice(hymnId) {
  choicesEl.classList.add('show');
  choiceTitle.textContent = `How do you experience Hymn ${hymnId}?`;
  choiceGrid.innerHTML = '';
  addChoice('Through feeling and emotion (Heart)', () => { 
    applyAffinity('heart', 8); 
    addCodexEntry(`hymn_${hymnId}_heart`); 
    choicesEl.classList.remove('show'); 
    // Navigate to next hymn or scene
    const nextHymn = parseInt(hymnId.split('.')[1]) + 1;
    if (nextHymn <= 191) {
      enterScene(`mandala1_hymn1_${nextHymn}`);
    } else {
      enterScene('mandala1_conclusion');
    }
  });
  addChoice('Through thought and analysis (Mind)', () => { 
    applyAffinity('mind', 8); 
    addCodexEntry(`hymn_${hymnId}_mind`); 
    choicesEl.classList.remove('show'); 
    // Navigate to next hymn or scene
    const nextHymn = parseInt(hymnId.split('.')[1]) + 1;
    if (nextHymn <= 191) {
      enterScene(`mandala1_hymn1_${nextHymn}`);
    } else {
      enterScene('mandala1_conclusion');
    }
  });
  addChoice('Through balance and integration (Unity)', () => { 
    applyAffinity('unity', 8); 
    addCodexEntry(`hymn_${hymnId}_unity`); 
    choicesEl.classList.remove('show'); 
    // Navigate to next hymn or scene
    const nextHymn = parseInt(hymnId.split('.')[1]) + 1;
    if (nextHymn <= 191) {
      enterScene(`mandala1_hymn1_${nextHymn}`);
    } else {
      enterScene('mandala1_conclusion');
    }
  });
}

function showAsvinsChoice(hymnId) {
  choicesEl.classList.add('show');
  choiceTitle.textContent = `How do you call upon the Ashvins in Hymn ${hymnId}?`;
  choiceGrid.innerHTML = '';
  addChoice('With heartfelt prayer for healing (Heart)', () => { 
    applyAffinity('heart', 8); 
    addCodexEntry(`asvins_${hymnId}_heart`); 
    choicesEl.classList.remove('show'); 
    // Navigate to next hymn or scene
    const nextHymn = parseInt(hymnId.split('.')[1]) + 1;
    if (nextHymn <= 191) {
      enterScene(`mandala1_hymn1_${nextHymn}`);
    } else {
      enterScene('mandala1_conclusion');
    }
  });
  addChoice('With precise ritual words (Mind)', () => { 
    applyAffinity('mind', 8); 
    addCodexEntry(`asvins_${hymnId}_mind`); 
    choicesEl.classList.remove('show'); 
    // Navigate to next hymn or scene
    const nextHymn = parseInt(hymnId.split('.')[1]) + 1;
    if (nextHymn <= 191) {
      enterScene(`mandala1_hymn1_${nextHymn}`);
    } else {
      enterScene('mandala1_conclusion');
    }
  });
  addChoice('With balanced approach to healing (Unity)', () => { 
    applyAffinity('unity', 8); 
    addCodexEntry(`asvins_${hymnId}_unity`); 
    choicesEl.classList.remove('show'); 
    // Navigate to next hymn or scene
    const nextHymn = parseInt(hymnId.split('.')[1]) + 1;
    if (nextHymn <= 191) {
      enterScene(`mandala1_hymn1_${nextHymn}`);
    } else {
      enterScene('mandala1_conclusion');
    }
  });
}

function showIndraChoice(hymnId) {
  choicesEl.classList.add('show');
  choiceTitle.textContent = `How do you approach Indra in Hymn ${hymnId}?`;
  choiceGrid.innerHTML = '';
  addChoice('With admiration for his power (Heart)', () => { 
    applyAffinity('heart', 8); 
    addCodexEntry(`indra_${hymnId}_heart`); 
    choicesEl.classList.remove('show'); 
    // Navigate to next hymn or scene
    const nextHymn = parseInt(hymnId.split('.')[1]) + 1;
    if (nextHymn <= 191) {
      enterScene(`mandala1_hymn1_${nextHymn}`);
    } else {
      enterScene('mandala1_conclusion');
    }
  });
  addChoice('With analysis of his deeds (Mind)', () => { 
    applyAffinity('mind', 8); 
    addCodexEntry(`indra_${hymnId}_mind`); 
    choicesEl.classList.remove('show'); 
    // Navigate to next hymn or scene
    const nextHymn = parseInt(hymnId.split('.')[1]) + 1;
    if (nextHymn <= 191) {
      enterScene(`mandala1_hymn1_${nextHymn}`);
    } else {
      enterScene('mandala1_conclusion');
    }
  });
  addChoice('With balanced respect for his power (Unity)', () => { 
    applyAffinity('unity', 8); 
    addCodexEntry(`indra_${hymnId}_unity`); 
    choicesEl.classList.remove('show'); 
    // Navigate to next hymn or scene
    const nextHymn = parseInt(hymnId.split('.')[1]) + 1;
    if (nextHymn <= 191) {
      enterScene(`mandala1_hymn1_${nextHymn}`);
    } else {
      enterScene('mandala1_conclusion');
    }
  });
}

function showVisnuChoice(hymnId) {
  choicesEl.classList.add('show');
  choiceTitle.textContent = `How do you perceive Vishnu in Hymn ${hymnId}?`;
  choiceGrid.innerHTML = '';
  addChoice('Through his cosmic presence (Heart)', () => { 
    applyAffinity('heart', 8); 
    addCodexEntry(`visnu_${hymnId}_heart`); 
    choicesEl.classList.remove('show'); 
    // Navigate to next hymn or scene
    const nextHymn = parseInt(hymnId.split('.')[1]) + 1;
    if (nextHymn <= 191) {
      enterScene(`mandala1_hymn1_${nextHymn}`);
    } else {
      enterScene('mandala1_conclusion');
    }
  });
  addChoice('Through his measured steps (Mind)', () => { 
    applyAffinity('mind', 8); 
    addCodexEntry(`visnu_${hymnId}_mind`); 
    choicesEl.classList.remove('show'); 
    // Navigate to next hymn or scene
    const nextHymn = parseInt(hymnId.split('.')[1]) + 1;
    if (nextHymn <= 191) {
      enterScene(`mandala1_hymn1_${nextHymn}`);
    } else {
      enterScene('mandala1_conclusion');
    }
  });
  addChoice('Through his universal balance (Unity)', () => { 
    applyAffinity('unity', 8); 
    addCodexEntry(`visnu_${hymnId}_unity`); 
    choicesEl.classList.remove('show'); 
    // Navigate to next hymn or scene
    const nextHymn = parseInt(hymnId.split('.')[1]) + 1;
    if (nextHymn <= 191) {
      enterScene(`mandala1_hymn1_${nextHymn}`);
    } else {
      enterScene('mandala1_conclusion');
    }
  });
}

function showVarunaChoice(hymnId) {
  choicesEl.classList.add('show');
  choiceTitle.textContent = `How do you relate to Varuna in Hymn ${hymnId}?`;
  choiceGrid.innerHTML = '';
  addChoice('Through his moral order (Heart)', () => { 
    applyAffinity('heart', 8); 
    addCodexEntry(`varuna_${hymnId}_heart`); 
    choicesEl.classList.remove('show'); 
    // Navigate to next hymn or scene
    const nextHymn = parseInt(hymnId.split('.')[1]) + 1;
    if (nextHymn <= 191) {
      enterScene(`mandala1_hymn1_${nextHymn}`);
    } else {
      enterScene('mandala1_conclusion');
    }
  });
  addChoice('Through his cosmic laws (Mind)', () => { 
    applyAffinity('mind', 8); 
    addCodexEntry(`varuna_${hymnId}_mind`); 
    choicesEl.classList.remove('show'); 
    // Navigate to next hymn or scene
    const nextHymn = parseInt(hymnId.split('.')[1]) + 1;
    if (nextHymn <= 191) {
      enterScene(`mandala1_hymn1_${nextHymn}`);
    } else {
      enterScene('mandala1_conclusion');
    }
  });
  addChoice('Through his balanced justice (Unity)', () => { 
    applyAffinity('unity', 8); 
    addCodexEntry(`varuna_${hymnId}_unity`); 
    choicesEl.classList.remove('show'); 
    // Navigate to next hymn or scene
    const nextHymn = parseInt(hymnId.split('.')[1]) + 1;
    if (nextHymn <= 191) {
      enterScene(`mandala1_hymn1_${nextHymn}`);
    } else {
      enterScene('mandala1_conclusion');
    }
  });
}

function showMarutsChoice(hymnId) {
  choicesEl.classList.add('show');
  choiceTitle.textContent = `How do you experience the Maruts in Hymn ${hymnId}?`;
  choiceGrid.innerHTML = '';
  addChoice('Through their stormy energy (Heart)', () => { 
    applyAffinity('heart', 8); 
    addCodexEntry(`maruts_${hymnId}_heart`); 
    choicesEl.classList.remove('show'); 
    // Navigate to next hymn or scene
    const nextHymn = parseInt(hymnId.split('.')[1]) + 1;
    if (nextHymn <= 191) {
      enterScene(`mandala1_hymn1_${nextHymn}`);
    } else {
      enterScene('mandala1_conclusion');
    }
  });
  addChoice('Through their natural order (Mind)', () => { 
    applyAffinity('mind', 8); 
    addCodexEntry(`maruts_${hymnId}_mind`); 
    choicesEl.classList.remove('show'); 
    // Navigate to next hymn or scene
    const nextHymn = parseInt(hymnId.split('.')[1]) + 1;
    if (nextHymn <= 191) {
      enterScene(`mandala1_hymn1_${nextHymn}`);
    } else {
      enterScene('mandala1_conclusion');
    }
  });
  addChoice('Through their balanced power (Unity)', () => { 
    applyAffinity('unity', 8); 
    addCodexEntry(`maruts_${hymnId}_unity`); 
    choicesEl.classList.remove('show'); 
    // Navigate to next hymn or scene
    const nextHymn = parseInt(hymnId.split('.')[1]) + 1;
    if (nextHymn <= 191) {
      enterScene(`mandala1_hymn1_${nextHymn}`);
    } else {
      enterScene('mandala1_conclusion');
    }
  });
}

function showUsasChoice(hymnId) {
  choicesEl.classList.add('show');
  choiceTitle.textContent = `How do you greet U·π£as in Hymn ${hymnId}?`;
  choiceGrid.innerHTML = '';
  addChoice('With joyful welcome (Heart)', () => { 
    applyAffinity('heart', 8); 
    addCodexEntry(`usas_${hymnId}_heart`); 
    choicesEl.classList.remove('show'); 
    // Navigate to next hymn or scene
    const nextHymn = parseInt(hymnId.split('.')[1]) + 1;
    if (nextHymn <= 191) {
      enterScene(`mandala1_hymn1_${nextHymn}`);
    } else {
      enterScene('mandala1_conclusion');
    }
  });
  addChoice('With dawn rituals (Mind)', () => { 
    applyAffinity('mind', 8); 
    addCodexEntry(`usas_${hymnId}_mind`); 
    choicesEl.classList.remove('show'); 
    // Navigate to next hymn or scene
    const nextHymn = parseInt(hymnId.split('.')[1]) + 1;
    if (nextHymn <= 191) {
      enterScene(`mandala1_hymn1_${nextHymn}`);
    } else {
      enterScene('mandala1_conclusion');
    }
  });
  addChoice('With balanced awakening (Unity)', () => { 
    applyAffinity('unity', 8); 
    addCodexEntry(`usas_${hymnId}_unity`); 
    choicesEl.classList.remove('show'); 
    // Navigate to next hymn or scene
    const nextHymn = parseInt(hymnId.split('.')[1]) + 1;
    if (nextHymn <= 191) {
      enterScene(`mandala1_hymn1_${nextHymn}`);
    } else {
      enterScene('mandala1_conclusion');
    }
  });
}

function showSuryaChoice(hymnId) {
  choicesEl.classList.add('show');
  choiceTitle.textContent = `How do you honor S≈´rya in Hymn ${hymnId}?`;
  choiceGrid.innerHTML = '';
  addChoice('With reverence for his light (Heart)', () => { 
    applyAffinity('heart', 8); 
    addCodexEntry(`surya_${hymnId}_heart`); 
    choicesEl.classList.remove('show'); 
    // Navigate to next hymn or scene
    const nextHymn = parseInt(hymnId.split('.')[1]) + 1;
    if (nextHymn <= 191) {
      enterScene(`mandala1_hymn1_${nextHymn}`);
    } else {
      enterScene('mandala1_conclusion');
    }
  });
  addChoice('With understanding of his cycles (Mind)', () => { 
    applyAffinity('mind', 8); 
    addCodexEntry(`surya_${hymnId}_mind`); 
    choicesEl.classList.remove('show'); 
    // Navigate to next hymn or scene
    const nextHymn = parseInt(hymnId.split('.')[1]) + 1;
    if (nextHymn <= 191) {
      enterScene(`mandala1_hymn1_${nextHymn}`);
    } else {
      enterScene('mandala1_conclusion');
    }
  });
  addChoice('With balanced solar wisdom (Unity)', () => { 
    applyAffinity('unity', 8); 
    addCodexEntry(`surya_${hymnId}_unity`); 
    choicesEl.classList.remove('show'); 
    // Navigate to next hymn or scene
    const nextHymn = parseInt(hymnId.split('.')[1]) + 1;
    if (nextHymn <= 191) {
      enterScene(`mandala1_hymn1_${nextHymn}`);
    } else {
      enterScene('mandala1_conclusion');
    }
  });
}

function showMandalaConclusion() {
  choicesEl.classList.add('show');
  choiceTitle.textContent = "How has Mandala I transformed you?";
  choiceGrid.innerHTML = '';
  addChoice('I feel more connected to the divine (Heart)', () => { 
    applyAffinity('heart', 15); 
    addCodexEntry('mandala1_heart_ending'); 
    choicesEl.classList.remove('show'); 
    enterScene('mandala1_conclusion');
  });
  addChoice('I understand the cosmic order better (Mind)', () => { 
    applyAffinity('mind', 15); 
    addCodexEntry('mandala1_mind_ending'); 
    choicesEl.classList.remove('show'); 
    enterScene('mandala1_conclusion');
  });
  addChoice('I found balance between feeling and knowing (Unity)', () => { 
    applyAffinity('unity', 15); 
    addCodexEntry('mandala1_unity_ending'); 
    unlockAchievement('rtaWeaver');
    choicesEl.classList.remove('show'); 
    enterScene('mandala1_conclusion');
  });
}

/* ---------- Event Listeners ---------- */
menuBtn.onclick = showMenu;
codexBtn.onclick = openCodex;
saveBtn.onclick = doSave;
vnMenuBtn.onclick = () => {
  if (window.showVNOverlay) {
    window.showVNOverlay();
  } else {
    console.error('showVNOverlay not available - menuOverlay.js may not be loaded');
  }
};
closeMenuBtn.onclick = closeMenu;
closeCodexBtn.onclick = closeCodex;
closeMeaningBtn.onclick = closeMeaningModal;

// Keyboard: Space / Enter trigger Next
document.addEventListener('keydown', (ev) => {
  const key = ev.key;
  if (key !== ' ' && key !== 'Enter') return;
  // Avoid when typing in inputs or content-editable
  const ae = document.activeElement;
  if (ae && (ae.tagName === 'INPUT' || ae.tagName === 'TEXTAREA' || ae.isContentEditable)) return;
  // Avoid when splash is visible
  if (typeof splash !== 'undefined' && splash && splash.style.display !== 'none') return;
  // Do not advance when choice/puzzle overlays are shown
  if (choicesEl.classList.contains('show') || puzzleEl.classList.contains('show')) return;
  // Prevent page scrolling on Space/Enter
  ev.preventDefault();
  if (nextBtn && !nextBtn.disabled) {
    nextBtn.click();
  }
});

/* ---------- Audio System ---------- */
(function(){
  const clamp = (v,min,max)=> Math.max(min, Math.min(max, v));
  const getVol = (k, def)=> clamp(((state.settings && typeof state.settings[k] === 'number') ? state.settings[k] : def)/100, 0, 1);
  let lastTypeAt = 0;
  const mkAudio = (src, loop=false)=>{
    try{
      const a = new Audio(src);
      a.preload = 'auto';
      a.loop = !!loop;
      return a;
    }catch(e){ return null; }
  }
  const makePlayable = (a, vol)=>{
    if (!a) return ()=>{};
    return ()=>{
      try{
        a.currentTime = 0;
        a.volume = vol();
        a.play().catch(()=>{});
      }catch(e){}
    };
  };
  const sfxClick = mkAudio('audio/ui_click.mp3');
  const sfxHover = mkAudio('audio/ui_hover.mp3');
  const sfxType  = mkAudio('audio/type_blip.mp3');
  let bgm = null;
  window.audio = {
    startBGM(){
      try{
        if (!bgm) bgm = mkAudio('audio/bgm_theme.mp3', true);
        if (!bgm) return;
        bgm.volume = getVol('bgmVolume', 60);
        bgm.play().catch(()=>{});
      }catch(e){}
    },
    playClick: makePlayable(sfxClick, ()=> getVol('sfxVolume', 70)),
    playHover: makePlayable(sfxHover, ()=> getVol('sfxVolume', 70)),
    playType(){
      try{
        const now = performance.now();
        if (now - lastTypeAt < 40) return; // throttle
        lastTypeAt = now;
        if (!sfxType) return;
        sfxType.volume = getVol('voiceVolume', 50) * 0.35;
        sfxType.currentTime = 0;
        sfxType.play().catch(()=>{});
      }catch(e){}
    },
    playChime(){
      // Fallback to click sound for character chime
      if (this.playClick) this.playClick();
    }
  };

  // Global button/choice/fab hover/click sounds (event delegation)
  document.addEventListener('click', (e)=>{
    const t = e.target;
    if (!t) return;
    if (t.classList && (t.classList.contains('btn') || t.classList.contains('fab') || t.classList.contains('choice'))) {
      if (window.audio && window.audio.playClick) window.audio.playClick();
    }
  }, true);
  document.addEventListener('mouseenter', (e)=>{
    const t = e.target;
    if (!t) return;
    if (t.classList && (t.classList.contains('btn') || t.classList.contains('fab') || t.classList.contains('choice'))) {
      if (window.audio && window.audio.playHover) window.audio.playHover();
    }
  }, true);
})();

// Expose state and functions to window for menuOverlay.js
window.state = state;
window.saveAuto = saveAuto;
window.updateHUD = updateHUD;
window.updateHymnInfo = updateHymnInfo;
window.updateCodexPanel = updateCodexPanel;
window.enterScene = enterScene;

// Initialize (Splash controls the start)
loadCodex();
updateHUD();
updateHymnInfo();

// Splash intro timing
setTimeout(()=>{ if (splashIntro1) splashIntro1.classList.add('show'); }, 350);
setTimeout(()=>{ if (splashIntro2) splashIntro2.classList.add('show'); }, 1000);
setTimeout(()=>{ if (startBtn) startBtn.style.display = ''; }, 1400);

// Start button begins the cinematic
if (startBtn) {
  startBtn.onclick = () => {
    if (splash) splash.style.display = 'none';
    if (window.audio && window.audio.startBGM) { window.audio.startBGM(); }
    if (window.scenes) {
      enterScene('intro_cinematic');
    } else {
      // Scenes not ready yet: retry shortly
      const tryStart = setInterval(()=>{
        if (window.scenes) {
          clearInterval(tryStart);
          enterScene('intro_cinematic');
        }
      }, 100);
    }
  };
}

// No splash menu button; Start begins the cinematic
</script>
<script src="menuOverlay.js"></script>
<script src="mandala1.js"></script>
<script>
// Defer starting; splash handles beginning the cinematic
if (!window.scenes) {
  // Keep a log for debugging if scenes didn't load
  console.error('Scenes not loaded yet - waiting for Start button to retry');
}
</script>
</body>
</html>
